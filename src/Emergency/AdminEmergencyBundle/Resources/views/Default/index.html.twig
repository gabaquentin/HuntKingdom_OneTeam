{% extends 'baseAdmin.html.twig' %}


{% block admin_emergency %}
    <style>
        #right-panel {
            font-family: 'Roboto','sans-serif';
            line-height: 30px;
            padding-left: 10px;
        }

        #right-panel select, #right-panel input {
            font-size: 15px;
        }

        #right-panel select {
            width: 100%;
        }

        #right-panel i {
            font-size: 12px;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map2 {
            height: 100%;
            float: left;
            width: 63%;
            height: 100%;
        }
        #right-panel {
            float: right;
            width: 34%;
            height: 100%;
        }
        .panel {
            height: 100%;
            overflow: auto;
        }
    </style>
    <!-- page content -->
    <div class="right_col" role="main">
        <div class="">
            <div class="page-title">
                <div class="title_left">
                    <h3>URGENCES <small></small></h3>
                </div>

                <div class="title_right">
                    <div class="col-md-5 col-sm-5 col-xs-12 form-group pull-right top_search">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Search for...">
                            <span class="input-group-btn">
                      <button class="btn btn-secondary" type="button">Go!</button>
                    </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="clearfix"></div>

            <div class="row">

                <!-- Listes des urgences -->

                <div class="col-md-12 col-sm-12 ">
                    <div class="x_panel">
                        <div class="x_title">
                            <h2>Ci joint la liste des urgences declarées par nos utilisateurs<small></small></h2>
                            <ul class="nav navbar-right panel_toolbox">
                                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                </li>
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                        <a class="dropdown-item" href="#">Settings 1</a>
                                        <a class="dropdown-item" href="#">Settings 2</a>
                                    </div>
                                </li>
                                <li><a class="close-link"><i class="fa fa-close"></i></a>
                                </li>
                            </ul>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="card-box table-responsive">
                                        <p class="text-muted font-13 m-b-30">
                                            Si vous souhaitez telecharger une copy de cette liste, cliquez sur un des bouttons si dessous en fonctions du type de fichier voulu !
                                        </p>
                                        <table id="datatable-buttons" class="table table-striped table-bordered" style="width:100%">
                                            <thead>
                                            <tr>
                                                <th>Id</th>
                                                <th>Utilisateur</th>
                                                <th>Adresse</th>
                                                <th>Latitude</th>
                                                <th>Longitude</th>
                                                <th>Description</th>
                                                <th>Compagnie</th>
                                                <th>Expedition</th>
                                                <th>Id Position</th>
                                                <th>Date de l'urgence</th>
                                                <th>Etat</th>
                                                <th>Action</th>
                                            </tr>
                                            </thead>


                                            <tbody>
                                            {% for u in urgence %}

                                                {% set address =  u.adresse|split(' ', 2) %}

                                                {% for statU in u %}
                                                    {{ statU.id }}
                                                    {% endfor %}

                                            <tr {% if(u.etat == 0) %}  style="background-color: #F78181" {% endif %}>
                                                <td>{{ u.id }}</td>
                                                <td>{{ u.utilisateur }}</td>
                                                <td><span title="cliquez pour copier" class="itineraire" id="{{ u.id }}" onclick="copyToClipboard(this)" onmouseover="mouseOver(this)" onmouseout="mouseOut(this)" style="cursor: pointer;" >{{ u.adresse }}</span></td>
                                                <td>{{ u.latitude }}</td>
                                                <td>{{ u.longitude }}</td>
                                                <td>{{ u.description }}</td>
                                                <td> {{ u.plus }}</td>
                                                <td> {% if u.expedition.nom is null %} null {% else %} {{ u.expedition.nom }} {% endif %} </td>
                                                <td><span title="cliquez pour copier" class="position" id="{{ u.id }}" onclick="copyToClipboard(this)" onmouseover="mouseOver(this)" onmouseout="mouseOut(this)" style="cursor: pointer;" >{{ u.place_id }}</span></td>
                                                <td>{{ u.date }}</td>
                                                <td>{% if(u.etat == 0) %}  <i class="fa fa-spinner" alt="En attente">En attente</i> {% endif %} {% if(u.etat == 1) %}  <i class="fa fa-check-square-o" alt="Intervention terminé">Terminé</i> {% endif %}</td>
                                                <td>
                                                    {% if (u.etat == 0) %}
                                                        <a href="{{ path('admin_emergency_traiter',{'id':u.id}) }}" class="btn btn-primary btn-xs"><i class="fa fa-thumbs-up"></i> Traité </a>
                                                    {% endif %}
                                                    {% if (u.etat == 1) %}
                                                        <a class="btn btn-success btn-xs"><i class="fa fa-plus-square"></i> Terminé </a>
                                                    {% endif %}

                                                </td>
                                            </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Localisation -->

                <div class="col-md-12 col-sm-12 ">
                    <div class="x_panel">
                        <div class="x_title">
                            <h2 >Localiser les emplacements des urgences ici <small></small></h2>
                            <ul class="nav navbar-right panel_toolbox">
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                        <a class="dropdown-item" id="dark">Mode sombre</a>
                                        <a class="dropdown-item" id="normal">Normal</a>
                                    </div>
                                </li>
                                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                </li>
                                <li><a class="close-link"><i class="fa fa-close"></i></a>
                                </li>
                            </ul>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="card-box table-responsive">

                                        <div id="floating-panel">
                                            <!-- Supply a default place ID for a place in Brooklyn, New York. -->
                                            <div class="field item form-group">
                                                <div class="col-md-12 col-sm-6" style="text-align: center">
                                                    <input class="form-control" id="place-id" class='name' placeholder="Copier l'id de l'emplacement " type="text" required='required'>
                                                <button type="button" id="submit" class="btn btn-success">Localiser l'urgence</button>
                                            </div>

                                        </div>
                                        <div id="map" style="height: 800px;"></div>
                                        <script>
                                            // change on mouse hover

                                            function mouseOver(element) {
                                                $(element).popover('show')
                                            }

                                            function mouseOut(element) {
                                                $(element).popover('hide')
                                            }

                                            // copy to clipboard on click


                                            function copyToClipboard(element) {
                                                var $temp = $("<input>");
                                                $("body").append($temp);
                                                $temp.val($(element).html()).select();
                                                document.execCommand("copy");
                                                $temp.remove();
                                            }

                                            // notify toatsr

                                            $('.position').on('click', function(){
                                                toastr.options = {
                                                    "closeButton": false,
                                                    "debug": false,
                                                    "newestOnTop": false,
                                                    "progressBar": false,
                                                    "rtl": false,
                                                    "positionClass": "toast-top-right",
                                                    "preventDuplicates": false,
                                                    "onclick": null,
                                                    "showDuration": 300,
                                                    "hideDuration": 1000,
                                                    "timeOut": 5000,
                                                    "extendedTimeOut": 1000,
                                                    "showEasing": "swing",
                                                    "hideEasing": "linear",
                                                    "showMethod": "slideDown",
                                                    "hideMethod": "fadeOut"
                                                }
                                                toastr["success"]("coller pour localiser l'emplacement", "copié")
                                            })

                                            $('.itineraire').on('click', function(){
                                                toastr.options = {
                                                    "closeButton": false,
                                                    "debug": false,
                                                    "newestOnTop": false,
                                                    "progressBar": false,
                                                    "rtl": false,
                                                    "positionClass": "toast-top-right",
                                                    "preventDuplicates": false,
                                                    "onclick": null,
                                                    "showDuration": 300,
                                                    "hideDuration": 1000,
                                                    "timeOut": 5000,
                                                    "extendedTimeOut": 1000,
                                                    "showEasing": "swing",
                                                    "hideEasing": "linear",
                                                    "showMethod": "slideDown",
                                                    "hideMethod": "fadeOut"
                                                }
                                                toastr["success"]("coller pour tracer l'itineraire", "copié")
                                            })

                                        </script>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                <!-- Itineraire -->

                <div class="col-md-12 col-sm-12 ">
                    <div class="x_panel">
                        <div class="x_title">
                            <h2>Tracer un itineraire vers l'emplacement d'une urgence ici<small> </small></h2>
                            <ul class="nav navbar-right panel_toolbox">
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                        <a class="dropdown-item" >Black</a>
                                        <a class="dropdown-item" >White</a>
                                    </div>
                                </li>
                                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                </li>
                                <li><a class="close-link"><i class="fa fa-close"></i></a>
                                </li>
                            </ul>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="card-box table-responsive">

                                        <div id="floating-panel">
                                            <!-- Supply a default place ID for a place in Brooklyn, New York. -->
                                            <div class="field item form-group">
                                                <div class="col-md-12 col-sm-6" style="text-align: center">
                                                    <input class="form-control" id="address" class='name' placeholder="Copier l'addresse de l'emplacement " type="text" required='required'>
                                                    <button type="button" id="submitDest" class="btn btn-success">Tracer l'itineraire</button>
                                                </div>

                                            </div>

                                        <div id="map2" style="height: 800px;"></div>
                                        <div id="right-panel">
                                            <p>Total Distance: <span id="total"></span></p>
                                        </div>

                                        <script>
                                            var now = new Date();
                                            var heure   = now.getHours();
                                            var infoWindow2,geoLoca;
                                            function initMap() {
                                                if(heure >= 17 || heure <= 6)
                                                {
                                                    var map2 = new google.maps.Map(document.getElementById('map2'), {
                                                        zoom: 8,
                                                        center: {lat: 33.886917, lng: 9.537499} , // Tunisia
                                                        styles: [
                                                            {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
                                                            {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
                                                            {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
                                                            {
                                                                featureType: 'administrative.locality',
                                                                elementType: 'labels.text.fill',
                                                                stylers: [{color: '#d59563'}]
                                                            },
                                                            {
                                                                featureType: 'poi',
                                                                elementType: 'labels.text.fill',
                                                                stylers: [{color: '#d59563'}]
                                                            },
                                                            {
                                                                featureType: 'poi.park',
                                                                elementType: 'geometry',
                                                                stylers: [{color: '#263c3f'}]
                                                            },
                                                            {
                                                                featureType: 'poi.park',
                                                                elementType: 'labels.text.fill',
                                                                stylers: [{color: '#6b9a76'}]
                                                            },
                                                            {
                                                                featureType: 'road',
                                                                elementType: 'geometry',
                                                                stylers: [{color: '#38414e'}]
                                                            },
                                                            {
                                                                featureType: 'road',
                                                                elementType: 'geometry.stroke',
                                                                stylers: [{color: '#212a37'}]
                                                            },
                                                            {
                                                                featureType: 'road',
                                                                elementType: 'labels.text.fill',
                                                                stylers: [{color: '#9ca5b3'}]
                                                            },
                                                            {
                                                                featureType: 'road.highway',
                                                                elementType: 'geometry',
                                                                stylers: [{color: '#746855'}]
                                                            },
                                                            {
                                                                featureType: 'road.highway',
                                                                elementType: 'geometry.stroke',
                                                                stylers: [{color: '#1f2835'}]
                                                            },
                                                            {
                                                                featureType: 'road.highway',
                                                                elementType: 'labels.text.fill',
                                                                stylers: [{color: '#f3d19c'}]
                                                            },
                                                            {
                                                                featureType: 'transit',
                                                                elementType: 'geometry',
                                                                stylers: [{color: '#2f3948'}]
                                                            },
                                                            {
                                                                featureType: 'transit.station',
                                                                elementType: 'labels.text.fill',
                                                                stylers: [{color: '#d59563'}]
                                                            },
                                                            {
                                                                featureType: 'water',
                                                                elementType: 'geometry',
                                                                stylers: [{color: '#17263c'}]
                                                            },
                                                            {
                                                                featureType: 'water',
                                                                elementType: 'labels.text.fill',
                                                                stylers: [{color: '#515c6d'}]
                                                            },
                                                            {
                                                                featureType: 'water',
                                                                elementType: 'labels.text.stroke',
                                                                stylers: [{color: '#17263c'}]
                                                            }
                                                        ]
                                                    });

                                                    var map = new google.maps.Map(document.getElementById('map'), {
                                                        zoom: 8,
                                                        center: {lat: 33.886917, lng: 9.537499},
                                                        styles: [
                                                            {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
                                                            {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
                                                            {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
                                                            {
                                                                featureType: 'administrative.locality',
                                                                elementType: 'labels.text.fill',
                                                                stylers: [{color: '#d59563'}]
                                                            },
                                                            {
                                                                featureType: 'poi',
                                                                elementType: 'labels.text.fill',
                                                                stylers: [{color: '#d59563'}]
                                                            },
                                                            {
                                                                featureType: 'poi.park',
                                                                elementType: 'geometry',
                                                                stylers: [{color: '#263c3f'}]
                                                            },
                                                            {
                                                                featureType: 'poi.park',
                                                                elementType: 'labels.text.fill',
                                                                stylers: [{color: '#6b9a76'}]
                                                            },
                                                            {
                                                                featureType: 'road',
                                                                elementType: 'geometry',
                                                                stylers: [{color: '#38414e'}]
                                                            },
                                                            {
                                                                featureType: 'road',
                                                                elementType: 'geometry.stroke',
                                                                stylers: [{color: '#212a37'}]
                                                            },
                                                            {
                                                                featureType: 'road',
                                                                elementType: 'labels.text.fill',
                                                                stylers: [{color: '#9ca5b3'}]
                                                            },
                                                            {
                                                                featureType: 'road.highway',
                                                                elementType: 'geometry',
                                                                stylers: [{color: '#746855'}]
                                                            },
                                                            {
                                                                featureType: 'road.highway',
                                                                elementType: 'geometry.stroke',
                                                                stylers: [{color: '#1f2835'}]
                                                            },
                                                            {
                                                                featureType: 'road.highway',
                                                                elementType: 'labels.text.fill',
                                                                stylers: [{color: '#f3d19c'}]
                                                            },
                                                            {
                                                                featureType: 'transit',
                                                                elementType: 'geometry',
                                                                stylers: [{color: '#2f3948'}]
                                                            },
                                                            {
                                                                featureType: 'transit.station',
                                                                elementType: 'labels.text.fill',
                                                                stylers: [{color: '#d59563'}]
                                                            },
                                                            {
                                                                featureType: 'water',
                                                                elementType: 'geometry',
                                                                stylers: [{color: '#17263c'}]
                                                            },
                                                            {
                                                                featureType: 'water',
                                                                elementType: 'labels.text.fill',
                                                                stylers: [{color: '#515c6d'}]
                                                            },
                                                            {
                                                                featureType: 'water',
                                                                elementType: 'labels.text.stroke',
                                                                stylers: [{color: '#17263c'}]
                                                            }
                                                        ]
                                                    });
                                                }
                                                else
                                                {
                                                    var map2 = new google.maps.Map(document.getElementById('map2'), {
                                                        zoom: 8,
                                                        center: {lat: 33.886917, lng: 9.537499}, // Tunisia
                                                    });

                                                    var map = new google.maps.Map(document.getElementById('map'), {
                                                        zoom: 8,
                                                        center: {lat: 33.886917, lng: 9.537499}
                                                    });
                                                }


                                                // geocode


                                                var geocoder = new google.maps.Geocoder;
                                                var infowindow = new google.maps.InfoWindow;

                                                document.getElementById('submit').addEventListener('click', function() {
                                                    geocodePlaceId(geocoder, map, infowindow);
                                                });

                                                // end geocode

                                                var directionsService = new google.maps.DirectionsService;
                                                var directionsRenderer = new google.maps.DirectionsRenderer({
                                                    draggable: true,
                                                    map: map2,
                                                    panel: document.getElementById('right-panel')
                                                });

                                                directionsRenderer.addListener('directions_changed', function() {
                                                    computeTotalDistance(directionsRenderer.getDirections());
                                                });

                                                infoWindow2 = new google.maps.InfoWindow;

                                                // Try HTML5 geolocation.
                                                if (navigator.geolocation) {
                                                    navigator.geolocation.getCurrentPosition(function(position) {
                                                        var pos = {
                                                            lat: position.coords.latitude,
                                                            lng: position.coords.longitude
                                                        };

                                                        geoLoca = pos.lat+', '+pos.lng;

                                                        if(document.getElementById('address').value === '')
                                                        {
                                                            displayRoute(geoLoca, geoLoca, directionsService,
                                                                directionsRenderer);
                                                        }

                                                        document.getElementById('submitDest').addEventListener('click', function() {
                                                            displayRoute(geoLoca, document.getElementById('address').value, directionsService,
                                                                directionsRenderer);
                                                        });

                                                    }, function() {
                                                        handleLocationError(true, infoWindow2, map2.getCenter());
                                                    });
                                                } else {
                                                    // Browser doesn't support Geolocation
                                                    handleLocationError(false, infoWindow2, map2.getCenter());
                                                }

                                            }

                                            function handleLocationError(browserHasGeolocation, infoWindow2, pos) {
                                                infoWindow2.setPosition(pos);
                                                infoWindow2.setContent(browserHasGeolocation ?
                                                    'Error: The Geolocation service failed.' :
                                                    'Error: Your browser doesn\'t support geolocation.');
                                                infoWindow2.open(map2);
                                            }

                                            function displayRoute(origin, destination, service, display) {
                                                service.route({
                                                    origin: origin,
                                                    destination: destination,
                                                    travelMode: 'DRIVING',
                                                    avoidTolls: true
                                                }, function(response, status) {
                                                    if (status === 'OK') {
                                                        display.setDirections(response);
                                                    } else {
                                                        alert('Could not display directions due to: ' + status);
                                                    }
                                                });
                                            }

                                            function computeTotalDistance(result) {
                                                var total = 0;
                                                var myroute = result.routes[0];
                                                for (var i = 0; i < myroute.legs.length; i++) {
                                                    total += myroute.legs[i].distance.value;
                                                }
                                                total = total / 1000;
                                                document.getElementById('total').innerHTML = total + ' km';
                                            }

                                            // geocode

                                            function geocodePlaceId(geocoder, map, infowindow) {
                                                var placeId = document.getElementById('place-id').value;
                                                geocoder.geocode({'placeId': placeId}, function(results, status) {
                                                    if (status === 'OK') {
                                                        if (results[0]) {
                                                            map.setZoom(11);
                                                            map.setCenter(results[0].geometry.location);
                                                            var marker = new google.maps.Marker({
                                                                map: map,
                                                                position: results[0].geometry.location
                                                            });
                                                            infowindow.setContent(results[0].formatted_address);
                                                            infowindow.open(map, marker);
                                                        } else {
                                                            window.alert('No results found');
                                                        }
                                                    } else {
                                                        window.alert('Geocoder failed due to: ' + status);
                                                    }
                                                });
                                            }

                                            // end geocode
                                        </script>
                                        <script async defer
                                                src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD2Ws0KYSjxNXXgRh8jRBGZgrXqgNHzWbI&callback=initMap">
                                        </script>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

        </div>
    </div>
    <div class="modal fade bd-example-modal-sm" id="overlay" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content" style="background-color: green;color: white;text-align: center;">
                Copié <i class="fa fa-check-circle"></i>
            </div>
        </div>
    </div>
    <!-- /page content -->

{% endblock %}